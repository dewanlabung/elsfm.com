import{D}from"./paginated-resources-BDxg6DLi.js";import{z as N,G as w,ag as P,I as k,J as j,aa as S,b as U,r as g,j as t,d as V,T as l,A as z,a8 as W,E as B,aH as q,ak as G,aI as L,W as Q,an as R,o as O,H,a3 as M,P as _,t as K,a as J,y as $,Q as X,av as Y,V as v,u as Z}from"./main-CUJEGI8U.js";import{F as ee}from"./FileUpload-CTBOdaGq.js";import{P as ae,F as te}from"./image-selector-GLpYAkj6.js";import{u as f,r as se,v as re}from"./file-upload-provider-DWaB2xE4.js";import{p as C}from"./pretty-bytes-bO14ePu9.js";import{g as ie}from"./generate-waveform-data-BFwf5N3g.js";import{o as ne}from"./open-upload-window-CboR35vP.js";import{F as oe}from"./form-chip-field-ehb7ckkp.js";import{G as le}from"./genre-B_3ZyEC1.js";import{F as E}from"./form-normalized-model-chip-field-R33Z1aXc.js";import{F as ce}from"./normalized-model-field-8T9JWy8W.js";import{F as me}from"./formatted-duration-2_MIaPa4.js";const A="tracks";function Ge(e,{onSuccess:a}={}){const{trans:s}=N();return w({mutationFn:i=>ue(i),onSuccess:i=>{k(s(j("Track created"))),S.invalidateQueries({queryKey:D(A)}),a==null||a(i)},onError:i=>P(i,e)})}function ue(e){return U.post(A,de(e)).then(a=>a.data)}function de(e){var a;return{...e,album_id:e.album_id?e.album_id:null,artists:(a=e.artists)==null?void 0:a.map(s=>s.id)}}function ge({fileUpload:e,status:a,className:s}){const i=(e==null?void 0:e.bytesUploaded)||0,r=g.useMemo(()=>C(e.file.size),[e.file.size]),o=g.useMemo(()=>C(i),[i]);let c;return a==="completed"?c=t.jsx(l,{message:"Upload complete"}):a==="aborted"?c=t.jsx(l,{message:"Upload cancelled"}):a==="failed"?c=t.jsx(l,{message:"Upload failed"}):a==="processing"?c=t.jsx(l,{message:"Processing upload..."}):a==="pending"?c=t.jsx(l,{message:"Waiting to start..."}):c=t.jsx(l,{message:":bytesUploaded of :totalBytes uploaded",values:{bytesUploaded:o,totalBytes:r}}),t.jsx("div",{className:V("text-xs text-muted",s),children:c})}function pe({fileUpload:e,status:a,onAbort:s,size:i="md",className:r}){return t.jsxs("div",{className:r,children:[t.jsxs("div",{className:"flex items-center justify-between gap-24",children:[t.jsx(ge,{fileUpload:e,status:a}),t.jsx(xe,{fileUpload:e,status:a,onAbort:s})]}),t.jsx(ae,{size:i==="sm"?"xs":"sm",radius:"rounded-sm",value:e.percentage,isIndeterminate:a==="processing"||a==="pending"})]})}function xe({fileUpload:e,status:a,onAbort:s}){f(o=>o.abortUpload),f(o=>o.clearInactive);const i=e.errorMessage;let r;if(a==="failed"){const o=i||j("This file could not be uploaded");r=t.jsx(F,{children:t.jsx(W,{variant:"danger",label:t.jsx(q,{value:o}),children:t.jsx(B,{className:"text-danger",size:"sm"})})})}else a==="aborted"?r=t.jsx(F,{children:t.jsx(G,{className:"text-warning",size:"sm"})}):a==="completed"||a==="processing"?r=t.jsx(F,{children:t.jsx(L,{size:"sm",className:"text-primary"})}):s?r=t.jsx(F,{children:t.jsx(Q,{size:"xs",onClick:()=>s(e.file.id),children:t.jsx(R,{})})}):r=t.jsx("div",{className:"h-30 w-30"});return t.jsx(z,{children:r})}function F({children:e,...a}){return t.jsx(O.div,{className:"flex h-30 w-30 items-center justify-center",...a,initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},exit:{scale:0,opacity:0},children:e})}function fe(){return w({mutationFn:e=>U.post(`tracks/${e.fileEntryId}/extract-metadata`,e).then(a=>je(a.data)),onError:e=>H(e)})}function je(e){const a={name:e.metadata.title,duration:e.metadata.duration,genres:e.metadata.genres||[],description:e.metadata.comment,lyric:e.metadata.lyrics,release_date:e.metadata.release_date,album_name:e.metadata.album_name};return e.metadata.album&&(a.album_id=e.metadata.album.id),e.metadata.artist&&(a.artists=[e.metadata.artist]),e.metadata.image&&(a.image=e.metadata.image.url),a}function Le(e,a){var s,i;!((s=e.getValues("artists"))!=null&&s.length)&&a.artists&&e.setValue("artists",a.artists),!e.getValues("image")&&a.image&&e.setValue("image",a.image),a.release_date&&e.setValue("release_date",a.release_date),(i=a.genres)!=null&&i.length&&e.setValue("genres",T(e.getValues("genres"),a.genres)),!e.getValues("name")&&a.album_name&&e.setValue("name",a.album_name)}function he(e,a){return{...a,...e,artists:T(a.artists,e.artists),genres:T(a.genres,e.genres,"name"),tags:T(a.tags,e.tags,"name")}}function T(e=[],a=[],s="id"){return a=a.filter(i=>!e.find(r=>r[s]===i[s])),[...e,...a]}function be(e){const a=fe(),s=g.useRef(e);s.current=e;const i=f(n=>n.uploadMultiple),r=f(n=>n.updateFileUpload),o=f(n=>n.getUpload),c=g.useCallback((n,d)=>{var u;r(n,{meta:{...((u=o(n))==null?void 0:u.meta)||{},...d}})},[r,o]),m=se({uploadType:M.media}),h=g.useMemo(()=>({restrictions:m,uploadType:M.media,onSuccess:(n,d)=>{c(d.id,{isExtractingMetadata:!0}),a.mutate({fileEntryId:n.id,autoMatchAlbum:s.current.autoMatchAlbum},{onSuccess:u=>{c(d.id,{isExtractingMetadata:!1});const x={...u,src:n.url};s.current.onMetadataChange(d,x)},onError:()=>{c(d.id,{isExtractingMetadata:!1})}})},onError:n=>{n&&k.danger(n)}}),[a,c,m]),b=g.useCallback(n=>{const d=n.filter(u=>!re(u,m));return n.length!==d.length&&k.danger(j(":count of your files is not supported.",{values:{count:n.length-d.length}})),d},[m]),y=g.useCallback(async n=>{if(b(n).length){n.forEach(u=>{var x,I;(I=(x=s.current).onUploadStart)==null||I.call(x,{name:u.name,uploadId:u.id})}),i(n,h);for(const u of n){c(u.id,{isGeneratingWave:!0});const x=await ie(u.native);x&&s.current.onMetadataChange(u,{waveData:x}),c(u.id,{isGeneratingWave:!1})}}},[h,i,c,b]);return{openFilePicker:g.useCallback(async()=>{const n=await ne({multiple:!0,types:m==null?void 0:m.allowedFileTypes});await y(n)},[y,m]),uploadTracks:y,validateUploads:b}}function ye(e){const a=f(r=>e?r.fileUploads.get(e):null);let s=!1,i;if(a){const r=a.meta,o=(r==null?void 0:r.isExtractingMetadata)||(r==null?void 0:r.isGeneratingWave);s=(a==null?void 0:a.status)==="pending"||(a==null?void 0:a.status)==="inProgress"||!!o,i=(a==null?void 0:a.status)==="completed"&&o?"processing":a==null?void 0:a.status}return{isUploading:s,status:i,activeUpload:a}}function ve(){const[e,a]=g.useState(),{setValue:s,watch:i,getValues:r}=_(),{openFilePicker:o}=be({onUploadStart:({uploadId:p})=>a(p),onMetadataChange:(p,n)=>{const d=he(n,r());Object.entries(d).forEach(([u,x])=>s(u,x,{shouldDirty:!0}))}}),{status:c,isUploading:m,activeUpload:h}=ye(e),b=f(p=>p.abortUpload),y=f(p=>p.clearInactive);return t.jsxs("div",{children:[t.jsx(K,{className:"w-full",variant:"flat",color:"primary",startIcon:t.jsx(ee,{}),disabled:m,onClick:()=>o(),children:i("src")?t.jsx(l,{message:"Replace file"}):t.jsx(l,{message:"Upload file"})}),h&&t.jsx(pe,{fileUpload:h,status:c,className:"mt-24",onAbort:p=>{b(p),y()}})]})}function Fe(e){return J({queryKey:["artists","search-suggestions",e],queryFn:()=>Te(e),placeholderData:$})}async function Te(e){return U.get("search/suggestions/artist",{params:e}).then(a=>a.data)}function ke({name:e,className:a}){const{trans:s}=N(),[i,r]=g.useState(""),{data:o,isLoading:c}=Fe({query:i});return t.jsx(oe,{className:a,name:e,label:t.jsx(l,{message:"Artists"}),isAsync:!0,inputValue:i,onInputValueChange:r,suggestions:o==null?void 0:o.results,placeholder:s(j("+Add artist")),isLoading:c,allowCustomValue:!1,children:o==null?void 0:o.results.map(m=>t.jsx(X,{value:m,startIcon:m.image?t.jsx("img",{className:"h-24 w-24 rounded-full object-cover",src:m.image,alt:""}):void 0,children:m.name},m.id))})}const Me="tag";function Qe({showExternalIdFields:e,showAlbumField:a=!0,uploadButton:s}){const{trans:i}=N(),r=Y();return t.jsxs("div",{className:"gap-24 md:flex",children:[t.jsxs("div",{className:"flex-shrink-0",children:[t.jsx(te,{name:"image",uploadType:M.artwork,variant:r?"input":"square",label:r?t.jsx(l,{message:"Image"}):null,previewSize:r?void 0:"w-full md:w-224 aspect-square",stretchPreview:!0}),t.jsx("div",{className:"mt-24",children:s||t.jsx(ve,{})})]}),t.jsxs("div",{className:"mt-24 flex-auto md:mt-0",children:[t.jsx(v,{name:"name",label:t.jsx(l,{message:"Name"}),className:"mb-24",required:!0,autoFocus:!0}),a&&t.jsx(ce,{className:"mb-24",label:t.jsx(l,{message:"Album"}),name:"album_id",endpoint:"search/suggestions/album"}),t.jsx(ke,{name:"artists",className:"mb-24"}),t.jsx(E,{label:t.jsx(l,{message:"Genres"}),placeholder:i(j("+Add genre")),model:le,name:"genres",allowCustomValue:!0,className:"mb-24"}),t.jsx(E,{label:t.jsx(l,{message:"Tags"}),placeholder:i(j("+Add tag")),model:Me,name:"tags",allowCustomValue:!0,className:"mb-24"}),t.jsx(v,{name:"description",label:t.jsx(l,{message:"Description"}),inputElementType:"textarea",rows:5,className:"mb-24"}),t.jsx(Ie,{}),e&&t.jsx(Ne,{}),e&&t.jsx(Ue,{})]})]})}function Ne(){return t.jsx(v,{name:"src",label:t.jsx(l,{message:"Playback source"}),className:"mb-24",minLength:1,maxLength:230,description:t.jsx(l,{message:"Supports audio, video, hls/dash stream and youtube video url. If left empty, best matching youtube video will be found automatically."})})}function Ue(){const{spotify_is_setup:e}=Z();return e?t.jsx(v,{name:"spotify_id",label:t.jsx(l,{message:"Spotify ID"}),className:"mb-24",minLength:22,maxLength:22}):null}function Ie(){const{watch:e}=_();return t.jsx(v,{required:!0,name:"duration",label:t.jsx(l,{message:"Duration (in milliseconds)"}),className:"mb-24",type:"number",min:1,max:864e5,description:t.jsx(l,{message:"Will appear on the site as: :preview",values:{preview:t.jsx(me,{ms:e("duration")})}})})}export{ke as F,Qe as T,Ge as a,ye as b,pe as c,ge as d,Me as e,Le as h,he as m,de as p,be as u};
