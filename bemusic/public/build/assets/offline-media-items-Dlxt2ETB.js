var T=Object.defineProperty;var B=(i,t,e)=>t in i?T(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var d=(i,t,e)=>B(i,typeof t!="symbol"?t+"":t,e);import{aF as v,aa as m,at as g}from"./main-CUJEGI8U.js";import{e as S}from"./extension-from-filename-O0XMuZye.js";class f{constructor(){d(this,"primaryKeyPath","id");d(this,"listeners",new Map);d(this,"db",null)}listen(t,e){const n=this.listeners.get(t)??[];return n.push(e),this.listeners.set(t,n),()=>{const s=(this.listeners.get(t)??[]).filter(a=>a!==e);this.listeners.set(t,s)}}async getItem(t,e){const a=(this.db??await this.getDatabase()).transaction([this.dbStoreName],"readonly").objectStore(this.dbStoreName),r=e?a.index(e).get(IDBKeyRange.only(t)):a.get(t);return new Promise(o=>{r.onsuccess=()=>o(r.result),r.onerror=()=>o(null)})}async getAllItems(t,e){const a=(await this.getDatabase()).transaction([this.dbStoreName],"readonly").objectStore(this.dbStoreName),r=t?a.index(t).getAll(IDBKeyRange.only(e)):a.getAll();return new Promise(o=>{r.onsuccess=()=>o(r.result),r.onerror=()=>o([])})}async getAllKeys(t,e){const a=(await this.getDatabase()).transaction([this.dbStoreName],"readonly").objectStore(this.dbStoreName),r=t?a.index(t).getAllKeys(IDBKeyRange.only(e)):a.getAllKeys();return new Promise(o=>{r.onsuccess=()=>o(r.result),r.onerror=()=>o([])})}async putItem(t){const a=(await this.getDatabase()).transaction([this.dbStoreName],"readwrite").objectStore(this.dbStoreName).put(t);return new Promise(r=>{a.onsuccess=()=>{var o;(o=this.listeners.get("onItemUpdated"))==null||o.forEach(l=>l(t)),r(!0)},a.onerror=()=>r(!1)})}async deleteItem(t){const e=await this.getItem(t);if(!e)return!0;const r=(await this.getDatabase()).transaction([this.dbStoreName],"readwrite").objectStore(this.dbStoreName).delete(t);return new Promise(o=>{r.onsuccess=()=>{var l;(l=this.listeners.get("onItemDeleted"))==null||l.forEach(c=>c(e)),o(!0)},r.onerror=()=>o(!1)})}async deleteAllItems(){const s=(await this.getDatabase()).transaction([this.dbStoreName],"readwrite").objectStore(this.dbStoreName).clear();return new Promise(a=>{s.onsuccess=()=>a(!0)})}async getDatabase(){return new Promise((t,e)=>{const n=indexedDB.open(this.dbName,this.dbVersion);n.onerror=()=>{var s;e(new Error(`Failed to open database: ${(s=n.error)==null?void 0:s.message}`))},n.onsuccess=()=>{t(n.result)},n.onupgradeneeded=s=>{const a=s.target.result;if(!a.objectStoreNames.contains(this.dbStoreName)){const r=a.createObjectStore(this.dbStoreName,{keyPath:this.primaryKeyPath});this.createIndices(r)}}})}createIndices(t){}refId(t,e){return e?`${e.id}-${e.model_type}`:`self-${t.id}`}}class x extends f{constructor(){super(...arguments);d(this,"dbName","downloaded_files");d(this,"dbVersion",1);d(this,"dbStoreName","files")}async add(e){return await this.putItem(e)?e:null}async getByTrackId(e){return this.getItem(+e)}async delete(e){return this.deleteItem(e.id)}async clear(){return this.deleteAllItems()}}const u=new x;async function P(i,t,e){const n=await w();if(await _(i.id))return!0;const{blob:s,contentType:a}=await N(i.id,t,e),r=`${i.id}`,l=await(await n.getFileHandle(r,{create:!0})).createWritable();return await l.write(s),await l.close(),!!await u.add({id:+i.id,name:r,size:s.size,contentType:a,extension:E(i,a),lastModified:Date.now()})}function E(i,t){const e=S(i.name);if(e)return e;const n=t.split(";")[0].trim().toLowerCase(),s=F[n];if(s)return s;const a=n.split("/")[1];return a||"mp3"}async function N(i,t,e){const n=`${v().settings.base_url}/tracks/${i}/download`,s=await fetch(n,{signal:t});if(!s.ok||!s.body)throw new Error(`Failed to download track playback data: ${s.status} ${s.statusText}`);const a=s.headers.get("content-length"),r=s.headers.get("content-type"),o=a?parseInt(a,10):null;if(!a||!r)throw new Error(`Failed to download track playback data: ${s.status} ${s.statusText}`);const l=s.body.getReader(),c=[];let h=0;for(;;){const{done:k,value:y}=await l.read();if(k)break;if(y&&(c.push(y),h+=y.length,e)){const A=o!==null?h/o*100:null;e({loaded:h,total:o,percentage:A})}}return{blob:new Blob(c),contentType:r}}async function _(i){const t=await u.getByTrackId(i);if(!t)return!1;try{return await(await w()).getFileHandle(t.name,{create:!1}),!0}catch(e){if(e.name==="NotFoundError")return!1;throw e}}const I="offline-playback-data";async function w(){return await(await navigator.storage.getDirectory()).getDirectoryHandle(I,{create:!0})}async function M(i){const t=await u.getByTrackId(i);if(!t)return!0;try{return await u.delete(t),await(await w()).removeEntry(t.name),!0}catch(e){if(e instanceof DOMException&&e.name==="NotFoundError")return!0;throw e}}async function q(){const i=await navigator.storage.getDirectory();u.clear();try{await i.removeEntry(I,{recursive:!0})}catch(t){if(!(t instanceof DOMException&&t.name==="NotFoundError"))throw t}return!0}const F={"audio/mpeg":"mp3","audio/mp3":"mp3","audio/mp4":"m4a","audio/x-m4a":"m4a","audio/aac":"aac","audio/aacp":"aac","audio/ogg":"ogg","audio/webm":"webm","audio/wav":"wav","audio/wave":"wav","audio/x-wav":"wav","audio/flac":"flac","audio/x-flac":"flac","video/mp4":"mp4","video/webm":"webm","video/ogg":"ogv"},b=new Map;class O extends f{constructor(){super(...arguments);d(this,"dbName","offlined_tracks");d(this,"dbVersion",1);d(this,"dbStoreName","tracks")}async makeTrackAvailableOffline(e,n,s){const a=await this.getItem(e.track.id);if(a){if(a.isDownloaded){const l=[...a.offlinedBy];return e.offlinedBy.forEach(c=>{l.includes(c)||l.push(c)}),this.putItem({...a,offlinedBy:l}),!0}else if(b.has(e.track.id))return b.get(e.track.id)}const r={id:e.track.id,isDownloaded:0,data:e.track,offlinedBy:e.offlinedBy},o=await this.putItem(r);try{if(o&&await P(e.track,n,s))return await this.putItem({...r,isDownloaded:1}),!0}catch(l){if(l instanceof DOMException&&l.name==="AbortError")return!1;if(l instanceof DOMException&&l.name==="QuotaExceededError")throw l;console.error("makeTrackAvailableOffline",l)}return!1}async getAllTrackIds({downloadedOnly:e,pendingOnly:n}={}){return e?this.getAllKeys("isDownloaded",1):n?this.getAllKeys("isDownloaded",0):this.getAllKeys()}async getAllDownloadedTracks(){return this.getAllItems("isDownloaded",1)}async deleteTrack(e,n){const s=this.refId({id:e},n),a=await this.getItem(e);if(!a)return!0;const r=a.offlinedBy.filter(o=>o!==s);return r.length===0?(M(e),this.deleteItem(e)):this.putItem({...a,offlinedBy:r})}async deleteTracksOfflinedBy(e){const n=await this.getTracksOfflinedBy(e);for(const s of n)await this.deleteTrack(s.id,e);return!0}async clear(){return this.deleteAllItems()}async get(e){return this.getItem(e)}async getTracksOfflinedBy(e){return await this.getAllItems("offlinedBy",this.refId(void 0,e))}createIndices(e){e.createIndex("isDownloaded","isDownloaded",{unique:!1}),e.createIndex("offlinedBy","offlinedBy",{multiEntry:!0})}}const D=new O;class Q extends f{constructor(){super(...arguments);d(this,"maxConcurrentDownloads",3);d(this,"dbName","offline_queue");d(this,"dbVersion",1);d(this,"dbStoreName","queue");d(this,"activeDownloads",new K(e=>{(this.listeners.get("onActiveDownloadsChanged")??[]).forEach(s=>s(e))}))}async addTracks(e,n){const s=e.map(a=>this.pushTrackToQueue(a,n));await Promise.allSettled(s),this.runQueue()}async deleteTrack(e){await this.deleteItem(e),this.activeDownloads.delete(e),this.runQueue()}async deleteTracksQueuedBy(e){const n=this.refId(void 0,e),s=await this.getAllItems("offlinedBy",n);for(const a of s)if(a.offlinedBy.length===1&&a.offlinedBy[0]===n)this.deleteTrack(a.id);else{const r=a.offlinedBy.filter(o=>o!==n);this.putItem({...a,offlinedBy:r})}}async runQueue(){const e=await this.getAllItems(),n=this.maxConcurrentDownloads-this.activeDownloads.size;for(let s=0;s<n;s++){const a=e.find(o=>!this.activeDownloads.has(o.id));if(!a)break;const r=new AbortController;this.activeDownloads.add(a.id,r),D.makeTrackAvailableOffline(a,r.signal,({percentage:o})=>{this.activeDownloads.update(a.track.id,o??0)}).catch(o=>{console.error("offlineTrack",o)}).finally(()=>{this.deleteItem(a.id),this.activeDownloads.delete(a.id),this.runQueue()})}}async getQueuedTracks(){return await this.getAllItems()}async getTracksQueuedBy(e){return await this.getAllItems("offlinedBy",this.refId(void 0,e))}getDownloadProgress(){return this.activeDownloads.getDownloadProgress()}async pushTrackToQueue(e,n){const s=await this.getItem(e.id),a=(s==null?void 0:s.offlinedBy)||[],r=this.refId(e,n);if(s&&a.includes(r))return!0;const o=[...a];o.push(r);const l={id:e.id,track:e,offlinedBy:o};try{return await this.putItem(l)}catch{return!1}}createIndices(e){e.createIndex("offlinedBy","offlinedBy",{multiEntry:!0})}}class K{constructor(t){d(this,"value",new Map);this.onChange=t}get size(){return this.value.size}add(t,e){this.value.set(t,{percentage:0,abortController:e}),this.onChange(this.getDownloadProgress())}update(t,e){const n=this.value.get(t),s=Math.trunc(e);n&&n.percentage!==s&&(this.value.set(t,{...n,percentage:s}),this.onChange(this.getDownloadProgress()))}delete(t){const e=this.value.get(t);e&&(e.abortController.abort("Cancelled by user"),this.value.delete(t),this.onChange(this.getDownloadProgress()))}has(t){return this.value.has(t)}getDownloadProgress(){return new Map([...this.value.entries()].map(([t,e])=>[t,e.percentage]))}}const p=new Q;class C extends f{constructor(){super(...arguments);d(this,"MAX_ITEMS",200);d(this,"primaryKeyPath","dbId");d(this,"dbName","offline_media_items");d(this,"dbVersion",1);d(this,"dbStoreName","media_items")}async addItem(e){if(await this.getItem(this.refId(e)))return!0;const s=await $(e),a={id:e.id,dbId:this.refId(void 0,e),lastSyncedAt:Date.now(),type:e.model_type,data:s.item};return await this.putItem(a)&&await p.addTracks(s.tracks,e),!0}async getAllPlaylists(){return this.getAllItems("type","playlist")}async getAllAlbums(){return this.getAllItems("type","album")}async getAlbumById(e){return this.getItem(this.refId(void 0,{id:e,model_type:"album"}),"dbId")}async getPlaylistById(e){return this.getItem(this.refId(void 0,{id:e,model_type:"playlist"}),"dbId")}async getAllPlaylistIds(){return(await this.getAllKeys("type","playlist")).map(e=>parseInt(`${e}`.split("-")[0]))}async getAllAlbumIds(){return(await this.getAllKeys("type","album")).map(e=>parseInt(`${e}`.split("-")[0]))}async delete(e){return await Promise.all([D.deleteTracksOfflinedBy(e),p.deleteTracksQueuedBy(e)]),this.deleteItem(this.refId(void 0,e))}async clear(){return this.deleteAllItems()}createIndices(e){e.createIndex("type","type"),e.createIndex("dbId","dbId")}}async function $(i){if(i.model_type==="playlist"){const t=await m.ensureQueryData(g.playlists.show(i.id).playlist("playlistPage",R.MAX_ITEMS));return{item:t.playlist,tracks:t.tracks.data}}else{const t=await m.ensureQueryData(g.albums.get(i.id,"albumPage"));return{item:{...t.album,tracks:[]},tracks:t.album.tracks??[]}}}const R=new C;export{p as a,R as b,q as c,u as d,D as o};
