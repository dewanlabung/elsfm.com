import{u as _,e as v,j as e,T as r,v as h,G as C,H as S,I as A,J as I,b as D,r as i,d as T,t as f,av as P,U,c1 as z,co as E,W as V,a6 as H,a4 as O,a5 as B,Q as y,D as q,A as Q,cn as $,ai as W,o as k,p as R,bT as G}from"./main-CUJEGI8U.js";import{L as w}from"./external-link-jlnQ3iTs.js";import{N as J}from"./comment-bar-new-comment-form-CyGo8E79.js";import{u as K}from"./use-delete-comments-Gq9uGbac.js";import{T as X,a as Y,R as b}from"./Reply-CVpUZh9g.js";import{F as g}from"./formatted-number-gsF1qEbc.js";import{F as Z}from"./formatted-duration-2_MIaPa4.js";import{M as ee}from"./MoreVert-BiULonS7.js";import{C as se}from"./confirmation-dialog-DVMbD2S1.js";import{I as te}from"./infinite-scroll-sentinel-Br7e5Kqx.js";import{u as ne}from"./use-flat-infinite-query-items-3ilhvvhN.js";import{u as ae}from"./useSuspenseInfiniteQuery-Vh8v-EaZ.js";import{C as re}from"./Comment-vFUyF-gf.js";import{S as p}from"./skeleton-BmWW5Jc-.js";import{u as oe}from"./use-linkified-string-DMs78B9_.js";function Ae(){const{player:s}=_(),{hasPermission:t}=v(),n=(s==null?void 0:s.track_comments)&&t("comments.view");return{canView:n,canCreate:n&&t("comments.create")}}function F({message:s}){const{user:t}=v();return t?null:e.jsxs("div",{className:"mx-auto my-40 max-w-850 rounded border border-dashed px-20 py-30 text-center",children:[e.jsx("div",{className:"mb-8 text-xl font-semibold",children:e.jsx(r,{message:"Account required"})}),e.jsx("div",{className:"text-base text-muted",children:e.jsx(r,{...s,values:{l:n=>e.jsx(h,{className:w,to:"/login",children:n}),r:n=>e.jsx(h,{className:w,to:"/register",children:n})}})})]})}function ie(s){return C({mutationFn:t=>le(s,t),onSuccess:()=>{A(I("Thanks for reporting. We will review this content."))},onError:t=>S(t)})}function le(s,t){return D.post("report",{reason:t.reason,model_id:s.id,model_type:s.model_type}).then(n=>n.data)}function ce(s){return C({mutationFn:t=>me(s,t),onSuccess:t=>{},onError:t=>S(t)})}function me(s,t){return D.post("vote",{vote_type:t.voteType,model_id:s.id,model_type:s.model_type}).then(n=>n.data)}function ue({model:s,className:t,showUpvotesOnly:n}){const a=ce(s),[l,u]=i.useState(s.upvotes||0),[c,o]=i.useState(s.downvotes||0),[m,j]=i.useState(s.current_vote),x=d=>{u(d.upvotes),o(d.downvotes),j(d.current_vote)};return e.jsxs("div",{className:T(t,"whitespace-nowrap"),children:[e.jsxs(f,{className:"gap-6",sizeClassName:"px-8 py-4",color:m==="upvote"?"primary":void 0,disabled:a.isPending,"aria-label":"Upvote",onClick:()=>{a.mutate({voteType:"upvote"},{onSuccess:d=>x(d.model)})},children:[e.jsx(X,{}),e.jsx("div",{children:e.jsx(g,{value:l})})]}),!n&&e.jsxs(f,{className:"gap-6",sizeClassName:"px-8 py-4",color:m==="downvote"?"primary":void 0,disabled:a.isPending,"aria-label":"Downvote",onClick:()=>{a.mutate({voteType:"downvote"},{onSuccess:d=>x(d.model)})},children:[e.jsx(Y,{}),e.jsx("div",{children:e.jsx(g,{value:c})})]})]})}function de({comment:s,commentable:t,canDelete:n}){const a=P(),{user:l,hasPermission:u}=v(),[c,o]=i.useState(!1),m=l!=null&&!s.deleted&&s.depth<5&&u("comments.create");return e.jsxs("div",{style:{paddingLeft:`${s.depth*20}px`},children:[e.jsxs("div",{className:"group flex min-h-70 items-start gap-24 py-18",children:[s.user?e.jsx(U,{user:s.user,size:a?"lg":"xl",circle:!0}):e.jsx(z,{label:"User"}),e.jsxs("div",{className:"flex-auto text-sm",children:[e.jsxs("div",{className:"mb-4 flex items-center gap-8",children:[s.user&&e.jsx(je,{user:s.user}),e.jsx("time",{className:"text-xs text-muted",children:e.jsx(E,{date:s.created_at})}),s.position?e.jsx(xe,{commentable:t,position:s.position}):null]}),e.jsx("div",{className:"whitespace-pre-line",children:s.deleted?e.jsx("span",{className:"italic text-muted",children:e.jsx(r,{message:"[COMMENT DELETED]"})}):s.content}),!s.deleted&&e.jsxs("div",{className:"-ml-8 mt-10 flex items-center gap-8",children:[m&&e.jsxs("div",{className:"contents",children:[e.jsx(f,{className:"max-md:hidden",sizeClassName:"text-sm px-8 py-4",startIcon:e.jsx(b,{}),onClick:()=>o(!c),children:e.jsx(r,{message:"Reply"})}),e.jsx(V,{className:"md:hidden",onClick:()=>o(!c),children:e.jsx(b,{})})]}),e.jsx(ue,{model:s,showUpvotesOnly:!0}),e.jsx(pe,{comment:s,canDelete:n,user:l})]})]})]}),c?e.jsx(J,{className:s!=null&&s.depth?void 0:"pl-20",commentable:t,inReplyTo:s,autoFocus:!0,onSuccess:()=>{o(!1)}}):null]})}const xe=i.memo(({commentable:s,position:t})=>{if(!s.duration)return null;const n=t/100*(s.duration/1e3);return e.jsx("span",{className:"text-xs text-muted",children:e.jsx(r,{message:"at :position",values:{position:e.jsx(Z,{seconds:n})}})})});function pe({comment:s,canDelete:t,user:n}){const a=K(),l=ie(s),[u,c]=i.useState(!1),o=(s.user_id===(n==null?void 0:n.id)||t)&&!s.deleted,m=()=>{l.mutate({})},j=x=>{c(!1),x&&a.mutate({commentIds:[s.id]})};return e.jsxs(i.Fragment,{children:[e.jsxs(O,{children:[e.jsx(f,{startIcon:e.jsx(ee,{}),sizeClassName:"text-sm px-8 py-4",children:e.jsx(r,{message:"More"})}),e.jsxs(B,{children:[e.jsx(y,{value:"report",onSelected:()=>m(),children:e.jsx(r,{message:"Report comment"})}),o&&e.jsx(y,{value:"delete",onSelected:()=>c(!0),children:e.jsx(r,{message:"Delete"})})]})]}),e.jsx(q,{type:"modal",isOpen:u,onClose:x=>j(x),children:e.jsx(se,{isDanger:!0,title:e.jsx(r,{message:"Delete comment?"}),body:e.jsx(r,{message:"Are you sure you want to delete this comment?"}),confirm:e.jsx(r,{message:"Delete"})})})]})}function je({user:s}){const{auth:t}=i.useContext(H);return t!=null&&t.getUserProfileLink?e.jsx(h,{to:t.getUserProfileLink(s),className:"text-base font-medium hover:underline",children:s.name}):e.jsx("div",{className:"text-base font-medium",children:s.name})}const L=I("Please <l>login</l> or <r>create account</r> to comment");function Pe({children:s,className:t,...n}){return e.jsx("div",{className:t,children:e.jsx(Q,{initial:!1,mode:"wait",children:e.jsx(i.Suspense,{fallback:e.jsx(ge,{children:s}),children:e.jsx(fe,{...n,children:s})})})})}function fe({commentable:s,canDeleteAllComments:t=!1,children:n,perPage:a}){var o,m;const l=ae($.commentable(s).list(a)),u=ne(l),c=((m=(o=l.data.pages[0])==null?void 0:o.pagination)==null?void 0:m.total)||0;return e.jsxs(e.Fragment,{children:[e.jsx(M,{children:e.jsx(r,{message:":count comments",values:{count:e.jsx(g,{value:c})}})}),n,e.jsx(F,{message:L}),e.jsx(he,{comments:u,canDeleteAllComments:t,commentable:s}),e.jsx(te,{query:l,variant:"loadMore"})]})}function M({children:s}){return e.jsxs("div",{className:"mb-8 flex items-center gap-8 border-b pb-8",children:[e.jsx(re,{size:"sm",className:"text-muted"}),s]})}function he({comments:s,commentable:t,canDeleteAllComments:n}){return s.length?e.jsx(k.div,{...R,children:s.map(a=>e.jsx(de,{comment:a,commentable:t,canDelete:n},a.id))},"comments"):e.jsx(W,{className:"mt-24",size:"sm",title:e.jsx(r,{message:"Seems a little quiet over here"}),description:e.jsx(r,{message:"Be the first to comment"})})}function ge({children:s}){return e.jsxs(e.Fragment,{children:[e.jsx(M,{children:e.jsx(r,{message:"Loading comments..."})}),s,e.jsx(F,{message:L}),e.jsx(ve,{count:4})]})}function ve({count:s}){return e.jsx(k.div,{...R,children:[...new Array(s).keys()].map(t=>e.jsxs("div",{className:"group flex min-h-70 items-start gap-24 py-18",children:[e.jsx(p,{variant:"avatar",radius:"rounded-full",size:"w-60 h-60"}),e.jsxs("div",{className:"flex-auto text-sm",children:[e.jsx(p,{className:"mb-4 max-w-184 text-base"}),e.jsx(p,{className:"text-sm"}),e.jsxs("div",{className:"mt-10 flex items-center gap-8",children:[e.jsx(p,{className:"max-w-70 text-sm"}),e.jsx(p,{className:"max-w-40 text-sm"}),e.jsx(p,{className:"max-w-60 text-sm"})]})]})]},t))},"loading-skeleton")}function Ue({description:s,className:t}){const n=oe(s),a=i.useRef(null),l=i.useRef(null),[u,c]=i.useState(!1),[o,m]=i.useState(!1);return G(()=>{var d,N;const j=((d=a.current)==null?void 0:d.getBoundingClientRect().height)||0;(((N=a.current)==null?void 0:N.scrollHeight)||0)>j&&c(!0)},[]),n?e.jsxs(i.Fragment,{children:[e.jsx("div",{ref:a,className:T("relative",t,!o&&"max-h-160 overflow-hidden",!o&&u&&"after:to-background after:absolute after:bottom-0 after:left-0 after:h-20 after:w-full after:bg-gradient-to-b after:from-transparent"),children:e.jsx("div",{ref:l,dangerouslySetInnerHTML:{__html:n}})}),u&&e.jsx(f,{size:"xs",className:"mt-20",variant:"outline",onClick:()=>m(!o),children:o?e.jsx(r,{message:"Show less"}):e.jsx(r,{message:"Show more"})})]}):null}export{Pe as C,Ue as T,Ae as u};
