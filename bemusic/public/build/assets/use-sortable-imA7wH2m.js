import{bW as B,r as R,am as j}from"./main-CUJEGI8U.js";import{$ as K}from"./getScrollParent--OCc5gFh.js";import{$ as Q}from"./useGlobalListeners-BeXr-yG1.js";import{U as N}from"./uploaded-file-ksxfN_l-.js";const P=new Map,m=new Map,V=new Map,A={status:"inactive"},W={onDragStart:()=>{},onDragEnter:()=>{},onDragOver:({e,ref:n,item:r,sortSession:t,onDropPositionChange:a})=>{var b;const f=t.dropPosition;let u=null;const v=(b=m.get(r))==null?void 0:b.rect;if(v){const c=v.top+v.height/2;e.clientY<=c?u="before":e.clientY>=c&&(u="after")}if(u!==f){const c=t.sortables.indexOf(r);if(t.dropPosition=u,a==null||a(t.dropPosition),X(t),n.current)if(t.dropPosition==="after")M(n.current,"bottom",t);else if(c===0)M(n.current,"top",t);else{const o=t.sortables[c-1],l=m.get(o);l!=null&&l.ref.current&&M(l.ref.current,"bottom",t)}const g=t.sortables.indexOf(r);if(t.activeIndex===g){t.finalIndex=t.activeIndex;return}(c>t.activeIndex?"after":"before")==="after"?t.finalIndex=t.dropPosition==="before"?g-1:g:t.finalIndex=t.dropPosition==="after"?g+1:g}},onDragEnd:e=>{X(e)}};function X(e){e!=null&&e.linePreviewEl&&(e.linePreviewEl.style.borderBottomColor="",e.linePreviewEl.style.borderTopColor="",e.linePreviewEl=void 0)}function M(e,n,r){const t="rgb(var(--be-primary))";n==="top"?e.style.borderTopColor=t:e.style.borderBottomColor=t,r&&(r.linePreviewEl=e)}function z(e,n,r){const t=B(n,0,e.length-1),a=B(r,0,e.length-1);if(t===a)return e;const f=e[t],u=a<t?-1:1;for(let v=t;v!==a;v+=u)e[v]=e[v+u];return e[a]=f,e}const J={onDragStart:()=>{},onDragOver:()=>{},onDragEnter:(e,n,r)=>{var a;const t=(a=m.get(e.sortables[r]))==null?void 0:a.ref.current;t&&(Z(t,r,n),z(e.sortables,r,n),e.finalIndex=n)},onDragEnd:()=>{}};function Z(e,n,r){const t=e.parentElement;if(r<0)t.prepend(e);else{n>-1&&n<=r&&r++;const a=t.children.item(r);a?a.before(e):t.append(e)}}function C(e,n,r){const t=e.slice();return t.splice(r<0?t.length+r:r,0,t.splice(n,1)[0]),t}const S="transform 0.2s cubic-bezier(0.2, 0, 0, 1)",ee={onDragStart:e=>{e.sortables.forEach((n,r)=>{const t=m.get(n);t!=null&&t.ref.current&&(t.ref.current.style.transition=S,(e==null?void 0:e.activeIndex)===r&&(t.ref.current.style.opacity="0.4"))})},onDragEnter:(e,n,r)=>{z(e.sortables,r,n);const t=e.sortables.map(a=>{var f;return(f=m.get(a))==null?void 0:f.rect});e.sortables.forEach((a,f)=>{if(!e)return;const u=C(t,n,e.activeIndex),v=t[f],b=u[f],c=m.get(a);if(c!=null&&c.ref.current&&b&&v){const g=b.left-v.left,y=b.top-v.top;c.ref.current.style.transform=`translate3d(${g}px, ${y}px, 0)`}}),e.finalIndex=n},onDragOver:()=>{},onDragEnd:e=>{e.sortables.forEach(n=>{const r=m.get(n);r!=null&&r.ref.current&&(r.ref.current.style.transform="",r.ref.current.style.transition="",r.ref.current.style.opacity="",r.ref.current.style.zIndex="")})}};function H(e){const n=new IntersectionObserver(r=>{r.forEach(t=>{const{width:a,height:f,left:u,top:v}=t.boundingClientRect,[b,c]=[...e].find(([,y])=>y.ref.current===t.target)||[];if(b==null||c==null)return;const g={width:a,height:f,left:u,top:v};e.set(b,{...c,rect:g})}),n.disconnect()});[...e.values()].forEach(r=>{r.ref.current&&n.observe(r.ref.current)})}let _=null;function G(e){_=e}function Y({e,rect:n,deltaX:r,deltaY:t}){return{rect:n,x:e.clientX,y:e.clientY,deltaX:r??0,deltaY:t??0,nativeEvent:e}}function te(e){return{left:e.left,top:e.top,width:e.width,height:e.height}}function re({id:e,disabled:n,ref:r,preview:t,hidePreview:a,...f}){const u=R.useRef(null),{addGlobalListener:v,removeAllGlobalListeners:b}=Q(),c=R.useRef({lastPosition:{x:0,y:0}}).current,g=R.useRef(f);g.current=f,R.useLayoutEffect(()=>(n?P.delete(e):P.set(e,{...P.get(e),id:e,ref:r,type:g.current.type,getData:g.current.getData}),()=>{P.delete(e)}),[e,n,g,r]);const y=s=>{V.forEach(D=>{var E;D.type===((E=P.get(e))==null?void 0:E.type)&&s(D)})},o=s=>{var I,x;s.stopPropagation();const D=P.get(e),E=r.current,T=!u.current||!c.clickedEl||u.current.contains(c.clickedEl);if(_||!E||!D||!T){s.preventDefault(),s.stopPropagation();return}H(m),G("drag"),a&&ne(s),s.dataTransfer.effectAllowed="move",c.lastPosition={x:s.clientX,y:s.clientY},c.currentRect=te(E.getBoundingClientRect());const w=Y({rect:c.currentRect,e:s});t!=null&&t.current&&t.current(D,O=>{s.dataTransfer.setDragImage(O,0,0)}),A.status="dragging",A.dragTargetId=e,r.current&&(r.current.dataset.dragging="true"),(x=(I=g.current).onDragStart)==null||x.call(I,w,D),requestAnimationFrame(()=>{y(O=>{var h;return(h=O.onDragStart)==null?void 0:h.call(O,w,D)})}),v(window,"dragover",l,!0)},l=s=>{var x,O;if(s.preventDefault(),!c.currentRect)return;const D=s.clientX-c.lastPosition.x,E=s.clientY-c.lastPosition.y,T={...c.currentRect,left:c.currentRect.left+D,top:c.currentRect.top+E},w=Y({rect:T,e:s,deltaX:D,deltaY:E}),I=P.get(e);I&&((O=(x=g.current).onDragMove)==null||O.call(x,w,I),y(h=>{var k;return(k=h.onDragMove)==null?void 0:k.call(h,w,I)})),c.lastPosition={x:s.clientX,y:s.clientY},c.currentRect=T};return{draggableProps:{draggable:!n,onDragStart:o,onDragEnd:s=>{var T,w;if(s.stopPropagation(),b(),!c.currentRect)return;G(null),L&&L.remove();const D=Y({rect:c.currentRect,e:s}),E=P.get(e);E&&((w=(T=g.current).onDragEnd)==null||w.call(T,D,E),y(I=>{var x;return(x=I.onDragEnd)==null?void 0:x.call(I,D,E,A.status)})),requestAnimationFrame(()=>{A.dragTargetId=void 0,A.status="inactive",r.current&&delete r.current.dataset.dragging})},onPointerDown:s=>{c.clickedEl=s.target}},dragHandleRef:u}}let L;function ne(e){L||(L=new Image,document.body.append(L),L.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="),e.dataTransfer.setDragImage(L,0,0)}async function ae(e){const n=[];for await(const r of e)n.push(r);return n}async function*ce(e){const n=[];for(const r of e.items)if(r.kind==="file"){const t=r.webkitGetAsEntry();t&&n.push(t)}for(const r of n)if(r.isFile){if(r.name===".DS_Store")continue;const t=await q(r);yield new N(t,r.fullPath)}else r.isDirectory&&(yield*U(r))}async function*U(e){const n=e.createReader();let r;do{r=await new Promise((t,a)=>{n.readEntries(t,a)});for(const t of r)if(t.isFile){if(t.name===".DS_Store")continue;const a=await q(t);yield new N(a,t.fullPath)}else t.isDirectory&&(yield*U(t))}while(r.length>0)}function q(e){return new Promise((n,r)=>e.file(n,r))}const oe=400;function le({id:e,disabled:n,ref:r,...t}){const a=R.useRef({dragOverElements:new Set,dropActivateTimer:void 0}).current,f=R.useRef(t);f.current=t,R.useLayoutEffect(()=>(m.set(e,{...m.get(e),disabled:n,id:e,ref:r}),()=>{m.delete(e)}),[e,f,n,r]);const u=o=>{var p;const l=f.current,d=l.allowDragEventsFromItself||r.current!==((p=o.ref)==null?void 0:p.current);return!!(o!=null&&o.type&&d&&l.types.includes(o.type)&&(!l.acceptsDrop||l.acceptsDrop(o)))},v=o=>{var d,p;const l=F(o);l&&((p=(d=f.current).onDragLeave)==null||p.call(d,l))};return{droppableProps:n?{}:{onDragOver:o=>{var d,p;o.preventDefault(),o.stopPropagation();const l=F(o);l&&u(l)&&((p=(d=f.current).onDragOver)==null||p.call(d,l,o))},onDragEnter:o=>{var d,p;if(o.stopPropagation(),a.dragOverElements.add(o.target),a.dragOverElements.size>1)return;const l=F(o);l&&u(l)&&((p=(d=f.current).onDragEnter)==null||p.call(d,l),clearTimeout(a.dropActivateTimer),typeof f.current.onDropActivate=="function"&&(a.dropActivateTimer=setTimeout(()=>{var s,D;l&&((D=(s=f.current).onDropActivate)==null||D.call(s,l))},oe)))},onDragLeave:o=>{o.stopPropagation(),a.dragOverElements.delete(o.target);for(const d of a.dragOverElements)o.currentTarget.contains(d)||a.dragOverElements.delete(d);if(a.dragOverElements.size>0)return;const l=F(o);l&&u(l)&&(v(o),clearTimeout(a.dropActivateTimer))},onDrop:async o=>{var d,p,s,D;o.preventDefault(),o.stopPropagation(),a.dragOverElements.clear(),v(o),clearTimeout(a.dropActivateTimer);const l=F(o);if(l)if((p=(d=f.current).onDragLeave)==null||p.call(d,l),!u(l))A.status!=="inactive"&&(A.status="dropFail");else{const E=(D=(s=f.current).onDrop)==null?void 0:D.call(s,l);A.status!=="inactive"&&(A.status=E===!1?"dropFail":"dropSuccess")}}}}}function F(e){if(A.dragTargetId!=null)return P.get(A.dragTargetId);if(e.dataTransfer.types.includes("Files"))return{type:"nativeFile",el:null,ref:null,getData:()=>ae(ce(e.dataTransfer))}}let i=null;const $={line:W,liveSort:ee,moveNode:J};function de({item:e,items:n,type:r,ref:t,onSortEnd:a,onSortStart:f,onDragEnd:u,preview:v,disabled:b,onDropPositionChange:c,strategy:g="liveSort"}){R.useEffect(()=>{!b&&(i==null?void 0:i.type)===r&&i.sortables.length!==n.length&&(i.sortables=[...n],i.activeIndex=n.indexOf(e))},[n,e]);const{draggableProps:y,dragHandleRef:o}=re({id:e,ref:t,type:r,preview:v,disabled:b,onDragStart:()=>{var d;i={type:r,sortables:[...n],activeSortable:e,activeIndex:n.indexOf(e),finalIndex:n.indexOf(e),dropPosition:null,ref:t,scrollParent:t.current?K(t.current):void 0,scrollListener:()=>{H(m)}},$[g].onDragStart(i),f==null||f(),(d=i.scrollParent)==null||d.addEventListener("scroll",i.scrollListener)},onDragEnd:d=>{var p;i&&(i.dropPosition=null,c==null||c(i.dropPosition),i.activeIndex!==i.finalIndex&&(a==null||a(i.activeIndex,i.finalIndex)),(p=i.scrollParent)==null||p.removeEventListener("scroll",i.scrollListener),$[g].onDragEnd(i),u==null||u(),i=null)},getData:()=>{}}),{droppableProps:l}=le({id:e,ref:t,types:[r],disabled:b,allowDragEventsFromItself:!0,onDragOver:(d,p)=>{i&&$[g].onDragOver({e:p,ref:t,item:e,sortSession:i,onDropPositionChange:c})},onDragEnter:()=>{if(!i)return;const d=i.sortables.indexOf(e),p=i.sortables.indexOf(i.activeSortable);$[g].onDragEnter(i,d,p)},onDragLeave:()=>{i&&(i.dropPosition=null,c==null||c(i.dropPosition))}});return{sortableProps:{...j(y,l)},dragHandleRef:o}}export{le as a,C as m,de as u};
