import{z as F,G as P,ag as k,I as N,J as n,aa as u,bx as m,b as T,a as R,j as e,as as M,T as a,Q as w,V as U,cw as H,$ as I,M as A,a0 as q,a1 as E,a2 as Q,t as g,ab as W,D as p,a9 as G,r as V,W as j,a8 as y,an as L}from"./main-CUJEGI8U.js";import{a as S}from"./admin-config-DTFkVWJm.js";import{D as O}from"./settings-links-6v3CjZ6H.js";import{d as b,F as v,u as $,a as J,G as X,D as Y,b as Z,c as ee}from"./use-datatable-query-D9uebfzx.js";import{D as se}from"./datatable-filters-DFYg3QEK.js";import{a as ae,D as te,b as ie,c as re}from"./datatable-page-with-header-layout-C4e5sJMc.js";import{T as ne}from"./table-CgoYghfp.js";import{F as h}from"./formatted-date-DzIPJwiH.js";import{E as oe}from"./Edit-BRVJ8AkN.js";import{P as le}from"./Pause-B4fj-x54.js";import{P as ce}from"./PlayArrow-BmILjttv.js";import{C as f}from"./confirmation-dialog-DVMbD2S1.js";import{u as z}from"./use-cancel-subscription-CrzYdoE1.js";import{u as de}from"./use-resume-subscription-Cr1rig4A.js";import{N as me}from"./name-with-avatar-CpbvmPVO.js";import{D as ue}from"./data-table-add-item-button-_qDHIKil.js";import{D as B}from"./dialog-footer-jZcc-BBM.js";import{F as D}from"./date-picker-CE2IMMIh.js";import{F as C}from"./select-Z9R0wV6S.js";import{F as pe}from"./formatted-price-o7rYOnCC.js";import{F as xe}from"./normalized-model-field-8T9JWy8W.js";import{t as be,c as ge,u as je}from"./timestamp-filters-DydeeDDl.js";import"./Album-pwm22nnR.js";import"./Comment-vFUyF-gf.js";import"./FileUpload-CTBOdaGq.js";import"./Mic-DAPkQZuC.js";import"./PlaylistPlay-DcgxbGJx.js";import"./QueueMusic-CiX-EN5z.js";import"./Sell-D56iqjs7.js";import"./external-link-jlnQ3iTs.js";import"./FilterAlt-Cw-mRuQp.js";import"./form-normalized-model-chip-field-R33Z1aXc.js";import"./use-normalized-models-ClA2DWxP.js";import"./form-chip-field-ehb7ckkp.js";import"./input-DAWJLQiY.js";import"./chip-list-D0uDB84E.js";import"./accordion-BALGWyw-.js";import"./checkbox-suk8vW77.js";import"./CheckBoxOutlineBlank-BgWeDdny.js";import"./ArrowRightAlt-iO8zeT1U.js";import"./DateRange-Bhvye4F9.js";import"./use-base-date-picker-state-DaWG2IMs.js";import"./use-date-formatter-m8TmZzOM.js";import"./DateFormatter-Dix9bfnP.js";import"./KeyboardArrowRight-CjTKdvdU.js";import"./use-date-range-picker-state-CSWp3d1-.js";import"./list-C96mDrnJ.js";import"./switch-4KDjemPX.js";import"./is-tablet-media-query-DhMPnSWn.js";import"./use-current-date-time-BhbL04rR.js";import"./skeleton-BmWW5Jc-.js";import"./dashboard-layout-context-DeTNv3yG.js";import"./ArrowDownward-BHYKFIfy.js";import"./useInteractOutside-BFJZ3Z5N.js";import"./useEffectEvent-pADbdn7r.js";import"./is-ctrl-or-shift-pressed-Bx-mqgCW.js";import"./use-pointer-events-DcvSqvAc.js";import"./useGlobalListeners-BeXr-yG1.js";import"./Add-B3RL66ee.js";import"./combobox-end-adornment-B0xReOuL.js";import"./formatted-number-gsF1qEbc.js";const he="billing/subscriptions";function ye(s){const{trans:t}=F();return P({mutationFn:i=>fe(i),onSuccess:()=>{N(t(n("Subscription created"))),u.invalidateQueries({queryKey:m.subscriptions.invalidateKey})},onError:i=>k(i,s)})}function fe(s){return T.post(he,s).then(t=>t.data)}function K({form:s,onSubmit:t,formId:i}){var x,d;const r=R(H.products.index()),c=s.watch("product_id"),o=(x=r.data)==null?void 0:x.products.find(l=>l.id===c);return e.jsxs(M,{id:i,form:s,onSubmit:t,children:[e.jsx(xe,{name:"user_id",className:"mb-20",endpoint:"normalized-models/user",label:e.jsx(a,{message:"User"})}),e.jsx(C,{name:"product_id",selectionMode:"single",className:"mb-20",label:e.jsx(a,{message:"Plan"}),children:(d=r.data)==null?void 0:d.products.filter(l=>!l.free).map(l=>e.jsx(w,{value:l.id,children:e.jsx(a,{message:l.name})},l.id))}),!(o!=null&&o.free)&&e.jsx(C,{name:"price_id",selectionMode:"single",className:"mb-20",label:e.jsx(a,{message:"Price"}),children:o==null?void 0:o.prices.map(l=>e.jsx(w,{value:l.id,children:e.jsx(pe,{price:l})},l.id))}),e.jsx(U,{inputElementType:"textarea",rows:3,name:"description",label:e.jsx(a,{message:"Description"}),className:"mb-20"}),e.jsx(D,{className:"mb-20",name:"renews_at",granularity:"day",label:e.jsx(a,{message:"Renews at"}),description:e.jsx(a,{message:"This will only change local records. User will continue to be billed on their original cycle on the payment gateway."})}),e.jsx(D,{className:"mb-20",name:"ends_at",granularity:"day",label:e.jsx(a,{message:"Ends at"}),description:e.jsx(a,{message:"This will only change local records. User will continue to be billed on their original cycle on the payment gateway."})})]})}function we(){const{close:s,formId:t}=I(),i=A({}),r=ye(i);return e.jsxs(q,{children:[e.jsx(E,{children:e.jsx(a,{message:"Add new subscription"})}),e.jsx(Q,{children:e.jsx(K,{formId:t,form:i,onSubmit:c=>{r.mutate(c,{onSuccess:()=>{s()}})}})}),e.jsxs(B,{children:[e.jsx(g,{onClick:()=>{s()},children:e.jsx(a,{message:"Cancel"})}),e.jsx(g,{form:t,disabled:r.isPending,variant:"flat",color:"primary",type:"submit",children:e.jsx(a,{message:"Save"})})]})]})}const _=[{key:"ends_at",label:n("Status"),description:n("Whether subscription is active or cancelled"),defaultOperator:b.eq,control:{type:v.Select,defaultValue:"active",options:[{key:"active",label:n("Active"),value:{value:null,operator:b.eq}},{key:"cancelled",label:n("Cancelled"),value:{value:null,operator:b.ne}}]}},{control:{type:v.Select,defaultValue:"stripe",options:[{key:"stripe",label:n("Stripe"),value:"stripe"},{key:"paypal",label:n("PayPal"),value:"paypal"},{key:"none",label:n("None"),value:"none"}]},key:"gateway_name",label:n("Gateway"),description:n("With which payment provider was subscription created"),defaultOperator:b.eq},be({key:"renews_at",label:n("Renew date"),description:n("Date subscription will renew")}),ge({description:n("Date subscription was created")}),je({description:n("Date subscription was last updated")})],Se=""+new URL("subscriptions-84PnlvDT.svg",import.meta.url).href;function ve(s){const{trans:t}=F();return P({mutationFn:i=>De(i),onSuccess:()=>{N(t(n("Subscription updated"))),u.invalidateQueries({queryKey:m.subscriptions.invalidateKey})},onError:i=>k(i,s)})}function De({id:s,...t}){return T.put(`billing/subscriptions/${s}`,t).then(i=>i.data)}function Ce({subscription:s}){const{close:t,formId:i}=I(),r=A({defaultValues:{id:s.id,product_id:s.product_id,price_id:s.price_id,description:s.description,renews_at:s.renews_at,ends_at:s.ends_at,user_id:s.user_id}}),c=ve(r);return e.jsxs(q,{size:"md",children:[e.jsx(E,{children:e.jsx(a,{message:"Update subscription"})}),e.jsx(Q,{children:e.jsx(K,{formId:i,form:r,onSubmit:o=>{c.mutate(o,{onSuccess:()=>{t()}})}})}),e.jsxs(B,{children:[e.jsx(g,{onClick:()=>{t()},children:e.jsx(a,{message:"Cancel"})}),e.jsx(g,{form:i,disabled:c.isPending,variant:"flat",color:"primary",type:"submit",children:e.jsx(a,{message:"Save"})})]})]})}const _e=[{key:"user_id",allowsSorting:!0,width:"flex-3 min-w-200",visibleInMode:"all",header:()=>e.jsx(a,{message:"Customer"}),body:s=>s.user&&e.jsx(me,{image:s.user.image,label:s.user.name,description:s.user.email})},{key:"status",width:"w-100 flex-shrink-0",header:()=>e.jsx(a,{message:"Status"}),body:s=>e.jsx(G,{size:"xs",color:s.valid?"positive":"danger",radius:"rounded",className:"w-max",children:s.gateway_status})},{key:"product_id",allowsSorting:!0,header:()=>e.jsx(a,{message:"Plan"}),body:s=>{var t;return(t=s.product)==null?void 0:t.name}},{key:"gateway_name",allowsSorting:!0,header:()=>e.jsx(a,{message:"Gateway"}),body:s=>e.jsx("span",{className:"capitalize",children:s.gateway_name})},{key:"renews_at",allowsSorting:!0,header:()=>e.jsx(a,{message:"Renews at"}),body:s=>e.jsx(h,{date:s.renews_at})},{key:"ends_at",allowsSorting:!0,header:()=>e.jsx(a,{message:"Ends at"}),body:s=>e.jsx(h,{date:s.ends_at})},{key:"created_at",allowsSorting:!0,header:()=>e.jsx(a,{message:"Created at"}),body:s=>e.jsx(h,{date:s.created_at})},{key:"actions",header:()=>e.jsx(a,{message:"Actions"}),hideHeader:!0,align:"end",visibleInMode:"all",width:"w-[168px] flex-shrink-0",body:s=>e.jsx(Fe,{subscription:s})}];function Bs(){const{searchParams:s,sortDescriptor:t,mergeIntoSearchParams:i,setSearchQuery:r,isFiltering:c}=$(W),o=J(m.subscriptions.index({...s,with:"product"})),x=e.jsxs(p,{type:"modal",children:[e.jsx(ue,{children:e.jsx(a,{message:"Add new subscription"})}),e.jsx(we,{})]});return e.jsxs(ae,{children:[e.jsx(X,{query:o}),e.jsx(te,{title:e.jsx(a,{message:"Subscriptions"}),showSidebarToggleButton:!0,rightContent:S.pages.subscriptions?e.jsx(O,{variant:"button",link:S.pages.subscriptions,size:"xs"}):null}),e.jsxs(ie,{children:[e.jsx(Y,{searchValue:s.query,onSearchChange:r,actions:x,filters:_}),e.jsx(se,{filters:_}),e.jsxs(re,{children:[e.jsx(ne,{columns:_e,data:o.items,sortDescriptor:t,onSortChange:i,enableSelection:!1}),o.isEmpty&&e.jsx(Z,{className:"mt-50",isFiltering:c,image:Se,title:e.jsx(a,{message:"No subscriptions have been created yet"}),filteringTitle:e.jsx(a,{message:"No matching subscriptions"})}),e.jsx(ee,{query:o,onPageChange:d=>i({page:d}),onPerPageChange:d=>i({perPage:d})})]})]})]})}function Fe({subscription:s}){return e.jsxs(V.Fragment,{children:[e.jsxs(p,{type:"modal",children:[e.jsx(j,{size:"md",className:"text-muted",children:e.jsx(oe,{})}),e.jsx(Ce,{subscription:s})]}),s.cancelled&&s.on_grace_period?e.jsx(ke,{subscription:s}):null,s.active?e.jsx(Pe,{subscription:s}):null,e.jsx(Ne,{subscription:s})]})}function Pe({subscription:s}){const t=z(),i=()=>{t.mutate({subscriptionId:s.id},{onSuccess:()=>{u.invalidateQueries({queryKey:m.subscriptions.invalidateKey})}})};return e.jsxs(p,{type:"modal",onClose:r=>{r&&i()},children:[e.jsx(y,{label:e.jsx(a,{message:"Cancel subscription"}),children:e.jsx(j,{size:"md",className:"text-muted",disabled:t.isPending,children:e.jsx(le,{})})}),e.jsx(f,{title:e.jsx(a,{message:"Cancel subscription"}),body:e.jsxs("div",{children:[e.jsx(a,{message:"Are you sure you want to cancel this subscription?"}),e.jsx("div",{className:"mt-10 text-sm font-semibold",children:e.jsx(a,{message:"This will put user on grace period until their next scheduled renewal date. Subscription can be renewed until that date by user or from admin area."})})]}),confirm:e.jsx(a,{message:"Confirm"})})]})}function ke({subscription:s}){const t=de(),i=()=>{t.mutate({subscriptionId:s.id},{onSuccess:()=>{u.invalidateQueries({queryKey:m.subscriptions.invalidateKey})}})};return e.jsxs(p,{type:"modal",onClose:r=>{r&&i()},children:[e.jsx(y,{label:e.jsx(a,{message:"Renew subscription"}),children:e.jsx(j,{size:"md",className:"text-muted",onClick:i,disabled:t.isPending,children:e.jsx(ce,{})})}),e.jsx(f,{title:e.jsx(a,{message:"Resume subscription"}),body:e.jsxs("div",{children:[e.jsx(a,{message:"Are you sure you want to resume this subscription?"}),e.jsx("div",{className:"mt-10 text-sm font-semibold",children:e.jsx(a,{message:"This will put user on their original plan and billing cycle."})})]}),confirm:e.jsx(a,{message:"Confirm"})})]})}function Ne({subscription:s}){const t=z(),i=()=>{t.mutate({subscriptionId:s.id,delete:!0},{onSuccess:()=>{u.invalidateQueries({queryKey:m.subscriptions.invalidateKey})}})};return e.jsxs(p,{type:"modal",onClose:r=>{r&&i()},children:[e.jsx(y,{label:e.jsx(a,{message:"Delete subscription"}),children:e.jsx(j,{size:"md",className:"text-muted",disabled:t.isPending,children:e.jsx(L,{})})}),e.jsx(f,{isDanger:!0,title:e.jsx(a,{message:"Delete subscription"}),body:e.jsxs("div",{children:[e.jsx(a,{message:"Are you sure you want to delete this subscription?"}),e.jsx("div",{className:"mt-10 text-sm font-semibold",children:e.jsx(a,{message:"This will permanently delete the subscription and immediately cancel it on billing gateway. Subscription will not be renewable anymore."})})]}),confirm:e.jsx(a,{message:"Confirm"})})]})}export{Bs as Component};
