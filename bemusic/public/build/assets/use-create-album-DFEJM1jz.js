import{$ as D,j as e,a0 as w,a1 as A,T as a,a2 as E,as as S,t as g,P as M,Z as z,D as v,a8 as y,W as f,ai as G,aj as _,r as F,ax as q,an as B,R as L,z as U,av as Q,a3 as $,V as k,J as I,u as H,G as K,ag as O,I as J,aa as W,b as Z}from"./main-CUJEGI8U.js";import{u as T}from"./file-upload-provider-DWaB2xE4.js";import{F as X}from"./FileUpload-CTBOdaGq.js";import{A as Y}from"./Add-B3RL66ee.js";import{D as ee}from"./DragHandle-CQHOqRgB.js";import{E as se}from"./Edit-BRVJ8AkN.js";import{T as R,u as ae,h as re,m as N,b as te,d as oe,F as le,e as ie,p as ne}from"./track-form-CLrfwlwm.js";import{u as me}from"./use-update-track-form-8K0330m0.js";import{D as P}from"./dialog-footer-jZcc-BBM.js";import{C as de}from"./confirmation-dialog-DVMbD2S1.js";import{G as ce}from"./music-Bh2SQVZ2.js";import{u as ue}from"./use-create-track-form-DdtXewgZ.js";import{D as xe}from"./drag-preview-C1yWSaDk.js";import{u as pe}from"./use-sortable-imA7wH2m.js";import{G as je}from"./genre-B_3ZyEC1.js";import{F as C}from"./form-normalized-model-chip-field-R33Z1aXc.js";import{F as ge}from"./image-selector-GLpYAkj6.js";import{F as fe}from"./date-picker-CE2IMMIh.js";import{D as he}from"./paginated-resources-BDxg6DLi.js";function be({track:s,hideAlbumField:r}){const{formId:t,close:l}=D(),{form:i}=me(s);return e.jsxs(w,{size:"fullscreen",children:[e.jsx(A,{children:e.jsx(a,{message:"Edit “:name“ track",values:{name:s.name}})}),e.jsx(E,{children:e.jsx(S,{id:t,form:i,onSubmit:m=>{l(m)},onBeforeSubmit:()=>{i.clearErrors()},children:e.jsx(R,{showExternalIdFields:!0,showAlbumField:!r})})}),e.jsxs(P,{children:[e.jsx(g,{variant:"text",onClick:()=>l(),children:e.jsx(a,{message:"Cancel"})}),e.jsx(g,{form:t,variant:"flat",color:"primary",type:"submit",children:e.jsx(a,{message:"Update"})})]})]})}function ve({defaultValues:s,hideAlbumField:r}){const{formId:t,close:l}=D(),{form:i}=ue({defaultValues:s});return e.jsxs(w,{size:"fullscreen",children:[e.jsx(A,{children:e.jsx(a,{message:"Add new track"})}),e.jsx(E,{children:e.jsx(S,{id:t,form:i,onSubmit:m=>{l(m)},onBeforeSubmit:()=>{i.clearErrors()},children:e.jsx(R,{showExternalIdFields:!0,showAlbumField:!r})})}),e.jsxs(P,{children:[e.jsx(g,{variant:"text",onClick:()=>l(),children:e.jsx(a,{message:"Cancel"})}),e.jsx(g,{form:t,variant:"flat",color:"primary",type:"submit",children:e.jsx(a,{message:"Create"})})]})]})}function ye(){const s=M(),{watch:r,setValue:t,getValues:l}=s,{fields:i,remove:m,prepend:x,move:h}=z({name:"tracks"}),c=(n,o)=>{var u;const d=(u=l("tracks"))==null?void 0:u.findIndex(b=>b.uploadId===n);d!=null&&t(`tracks.${d}`,N(o,l(`tracks.${d}`)),{shouldDirty:!0})},{openFilePicker:p}=ae({onUploadStart:n=>x(N(n,{artists:s.getValues("artists"),genres:s.getValues("genres"),tags:s.getValues("tags")})),onMetadataChange:(n,o)=>{re(s,o),c(n.id,o)}}),j=r("tracks")||[];return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-12",children:[e.jsx("h2",{className:"my-24 text-xl font-semibold",children:e.jsx(a,{message:"Tracks"})}),e.jsx(g,{variant:"outline",color:"primary",size:"xs",className:"ml-auto",startIcon:e.jsx(X,{}),onClick:()=>p(),children:e.jsx(a,{message:"Upload tracks"})}),e.jsxs(v,{type:"modal",onClose:n=>{n&&x(n)},children:[e.jsx(y,{label:e.jsx(a,{message:"Create track"}),children:e.jsx(f,{variant:"outline",color:"primary",size:"xs",children:e.jsx(Y,{})})}),e.jsx(ve,{hideAlbumField:!0,defaultValues:{artists:r("artists"),tags:r("tags"),genres:r("genres")}})]})]}),i.map((n,o)=>{const d=j[o];return e.jsx(Fe,{track:d,onRemove:()=>m(o),onSort:(u,b)=>h(u,b),tracks:j,onUpdate:u=>{c(d.uploadId,u)}},n.id)}),i.length?null:e.jsx(G,{className:"mt-40",image:e.jsx(_,{src:ce}),title:e.jsx(a,{message:"This album does not have any tracks yet"})})]})}function Fe({track:s,tracks:r,onRemove:t,onUpdate:l,onSort:i}){const m=F.useRef(null),x=F.useRef(null),h=T(o=>o.abortUpload),c=T(o=>s.uploadId?o.fileUploads.get(s.uploadId):null),{isUploading:p,status:j}=te(s.uploadId),{sortableProps:n}=pe({disabled:p,ref:m,item:s,items:r,type:"albumFormTrack",preview:x,strategy:"line",onSortEnd:(o,d)=>{i(o,d)}});return e.jsxs("div",{className:"border-b border-t border-t-transparent py-4",ref:m,...n,children:[e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx(f,{className:"mr-14 flex-shrink-0",disabled:p,children:e.jsx(ee,{})}),e.jsx("div",{className:"flex-auto overflow-hidden overflow-ellipsis whitespace-nowrap",children:s.name}),c&&e.jsxs("div",{className:"mr-10 flex items-center",children:[e.jsx(oe,{fileUpload:c,status:j,className:"mr-10"}),e.jsx(q,{isIndeterminate:j==="processing",value:c.percentage,size:"sm"})]}),e.jsxs(v,{type:"modal",onClose:o=>{o&&l(o)},children:[e.jsx(y,{label:e.jsx(a,{message:"Edit track"}),children:e.jsx(f,{className:"ml-auto flex-shrink-0 text-muted",disabled:p,children:e.jsx(se,{})})}),e.jsx(be,{track:s,hideAlbumField:!0})]}),e.jsxs(v,{type:"modal",onClose:o=>{o&&(s.uploadId&&h(s.uploadId),t())},children:[e.jsx(y,{label:e.jsx(a,{message:"Remove track"}),children:e.jsx(f,{className:"flex-shrink-0 text-muted",children:e.jsx(B,{})})}),e.jsx(de,{isDanger:!0,title:e.jsx(a,{message:"Remove track"}),body:e.jsx(a,{message:"Are you sure you want to remove this track from the album?"}),confirm:e.jsx(a,{message:"Remove"})})]})]}),e.jsx(ke,{track:s,ref:x})]})}const ke=L.forwardRef(({track:s},r)=>{var l,i;let t=s.name;return(l=s.artists)!=null&&l.length&&(t+=`- ${(i=s.artists)==null?void 0:i[0].name}`),e.jsx(xe,{ref:r,children:()=>e.jsx("div",{className:"rounded bg-chip p-8 text-sm shadow",children:t})})});function He({showExternalIdFields:s}){const{trans:r}=U(),t=Q();return e.jsxs(F.Fragment,{children:[e.jsxs("div",{className:"gap-24 md:flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(ge,{name:"image",uploadType:$.artwork,label:t?e.jsx(a,{message:"Image"}):null,variant:t?"input":"square",previewSize:"md:w-full md:w-224 md:aspect-square",stretchPreview:!0})}),e.jsxs("div",{className:"mt-24 flex-auto md:mt-0",children:[e.jsx(k,{name:"name",label:e.jsx(a,{message:"Name"}),className:"mb-24",required:!0,autoFocus:!0}),e.jsx(fe,{name:"release_date",label:e.jsx(a,{message:"Release date"}),className:"mb-24",granularity:"day",description:e.jsx(a,{message:"Set a future date to schedule release to become public only on that date."})}),e.jsx(le,{name:"artists",className:"mb-24"}),e.jsx(C,{label:e.jsx(a,{message:"Genres"}),placeholder:r(I("+Add genre")),model:je,name:"genres",allowCustomValue:!0,className:"mb-24"}),e.jsx(C,{label:e.jsx(a,{message:"Tags"}),placeholder:r(I("+Add tag")),model:ie,name:"tags",allowCustomValue:!0,className:"mb-24"}),e.jsx(k,{name:"description",label:e.jsx(a,{message:"Description"}),inputElementType:"textarea",rows:5,className:"mb-24"}),s&&e.jsx(Ie,{})]})]}),e.jsx(ye,{})]})}function Ie(){const{spotify_is_setup:s}=H();return s?e.jsx(k,{name:"spotify_id",label:e.jsx(a,{message:"Spotify ID"}),className:"mb-24",minLength:22,maxLength:22}):null}const V="albums";function Ke(s){const{trans:r}=U();return K({mutationFn:t=>Te(t),onSuccess:()=>{J(r(I("Album created"))),W.invalidateQueries({queryKey:he(V)})},onError:t=>O(t,s)})}function Te(s){return Z.post(V,Ne(s)).then(r=>r.data)}function Ne(s){var r,t;return{...s,artists:(r=s.artists)==null?void 0:r.map(l=>l.id),tracks:(t=s.tracks)==null?void 0:t.map(l=>ne(l))}}export{He as A,Ne as p,Ke as u};
